@page "/TodaysInputs"
@inject IDbContextFactory<AppDbContext> ContextFactory;
@inject ILogger<TodaysInputs> Logger;
@inject NavigationManager NavigationManager;
@inject WrikeService WrikeService;

@using System.Security.Claims;

<PageTitle>Today's Inputs'</PageTitle>
<h1>Today's Inputs that will be added at the end of the day</h1>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Task Title</th>
            <th>Hours</th>
            <th>Date</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (hoursToAdds != null)
        {
            @foreach (var hoursToAdd in hoursToAdds)
            {
                <tr>
                    <td>@hoursToAdd.WrikeId</td>
                    <td>@hoursToAdd.Hours</td>
                    <td>@hoursToAdd.DateIn</td>
                    <td><button class="btn text-danger  fa-solid fa-trash-alt" @onclick="(()=> RowSelected(hoursToAdd))"></button></td>
                </tr>
            }
        }
    </tbody>
</table>


@code {
    [CascadingParameter] protected Task<AuthenticationState> AuthStat { get; set; }
    private List<HoursToAdd> hoursToAdds = new List<HoursToAdd>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using (var context = ContextFactory.CreateDbContext())
            {
                var user = (await AuthStat).User;
                if (!user.Identity!.IsAuthenticated)
                {
                    NavigationManager.NavigateTo("/Login");
                }
                var dbUser = await context.Users.FindAsync(user.Identity.Name);
                var accessToken = await WrikeService.EnsureValidAccessTokenAsync(dbUser.AccessToken, dbUser.WrikeId);
                if (accessToken == null) return;

                hoursToAdds = await context.HoursToAdd.Where(h => h.WrikeId == user.Identity.Name && h.DateIn == DateOnly.FromDateTime(DateTime.UtcNow)).ToListAsync();
                List<HoursToAdd> distinctTimeLogs = hoursToAdds.GroupBy(x => x.TaskId).Select(y => y.FirstOrDefault()).ToList(); 
                for (int i = 0; i < distinctTimeLogs.Count; i++)
                {
                    var task = await WrikeService.GetTaskDetailsAsync(accessToken, distinctTimeLogs[i].TaskId);
                    foreach (var data in hoursToAdds)
                    {
                        if (data.TaskId == distinctTimeLogs[i].TaskId)
                        {
                            data.WrikeId = task.data[0].title;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OnInitializedAsync");
        }
    }

    private async Task RowSelected(HoursToAdd hoursToAdd)
    {
        try
        {
            using (var context = ContextFactory.CreateDbContext())
            {
                context.HoursToAdd.Remove(hoursToAdd);
                await context.SaveChangesAsync();
                hoursToAdds.Remove(hoursToAdd);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error when deleting hoursToAdd input.");
        }
    }

}
