@page "/Timelogs"
@using WrikeTimeLogger.Models
@inject WrikeService WrikeService
@inject NavigationManager Navigation
@inject ILogger<Timelogs> Logger
@inject IDbContextFactory<AppDbContext> ContextFactory;


<PageTitle>Timelogs</PageTitle>

<h1>Weekly Timelogs</h1>

<div style="display: flex; align-items: center;">
    <h4 style="margin-right: 5px;">Weekly Time Added :</h4>
    <h4 readonly="true" style="font-weight:bold;" > @hours⌛</h4>
</div>


@if (timelogs == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Task Title</th>
                <th>Hours</th>
                <th>Time</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var timelogsDatum in timelogs.Data.OrderByDescending(x => x.CreatedDate))
            {
                <tr>
                    <td>@timelogsDatum.Comment</td>
                    <td>@timelogsDatum.Hours</td>
                    <td>@timelogsDatum.CreatedDate.ToLocalTime()</td>
                    <td><button class="btn text-danger  fa-solid fa-trash-alt" @onclick="(() => RowSelected(timelogsDatum))"></button></td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private TimelogsResponse timelogs;
    private string accessToken;
    private string hours;
    private string _wrikeId;
    [CascadingParameter] protected Task<AuthenticationState> AuthStat { get; set; }


    protected override async Task OnInitializedAsync()
    {
        // using (var context = ContextFactory.CreateDbContext())
        // {
        // var user = (await AuthStat).User;
        // var tokens = await dbContext.Users
        //     .Where(t => t.WrikeId == user.Identity!.Name)
        //     .AsNoTracking()
        //     .FirstOrDefaultAsync();
        using (var context = ContextFactory.CreateDbContext())
        {
            var user = (await AuthStat).User;
            var dbUser = await context.Users
                .Where(t => t.WrikeId == user.Identity!.Name)
                .AsNoTracking()
                .FirstOrDefaultAsync();
            if (dbUser == null) return;
            try
            {
                accessToken = dbUser.AccessToken;
                _wrikeId = dbUser.WrikeId;

                if (!string.IsNullOrEmpty(accessToken))
                {
                    accessToken = await WrikeService.EnsureValidAccessTokenAsync(accessToken, _wrikeId);
                    timelogs = await WrikeService.GetWeeklyTimeLogs(accessToken);
                    hours = timelogs.Data.Sum(e => e.Hours).ToString();
                    List<TimelogsResponse.TimelogsDatum> distinctTimeLogs = timelogs.Data.GroupBy(x => x.TaskId).Select(y => y.FirstOrDefault()).ToList(); //TODO!!

                    for (int i = 0; i < distinctTimeLogs.Count; i++)
                    {
                        var task = await WrikeService.GetTaskDetailsAsync(accessToken, distinctTimeLogs[i].TaskId);
                        foreach (var data in timelogs.Data)
                        {
                            if (data.TaskId == distinctTimeLogs[i].TaskId)
                            {
                                data.Comment = task.data[0].title;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, $"Error loading timelogs for the user: {dbUser.Name}");
            }
        }
        // var tokens = await Users.GetSavedTokensAsync();
        
        // if (tokens==null) return;
        // try
        // {
        //     accessToken = tokens.AccessToken;
        //     refreshToken = tokens.RefreshToken;

        //     if (!string.IsNullOrEmpty(accessToken))
        //     {
        //         accessToken = await WrikeService.EnsureValidAccessTokenAsync(accessToken, refreshToken);
        //         timelogs = await WrikeService.GetWeeklyTimeLogs(accessToken);
        //         hours = timelogs.Data.Sum(e => e.Hours).ToString();
        //         List<TimelogsResponse.TimelogsDatum> distinctTimeLogs = timelogs.Data.GroupBy(x => x.TaskId).Select(y => y.FirstOrDefault()).ToList(); //TODO!!

        //         for (int i = 0; i < distinctTimeLogs.Count; i++)
        //         {
        //             var task = await WrikeService.GetTaskDetailsAsync(accessToken, distinctTimeLogs[i].TaskId);
        //             foreach (var data in timelogs.Data)
        //             {
        //                 if (data.TaskId == distinctTimeLogs[i].TaskId)
        //                 {
        //                     data.Comment = task.data[0].title;
        //                 }
        //             }
        //         }
        //     }
        // }
        // catch(Exception ex)
        // {
        //     Logger.LogError(ex, $"Error loading timelogs for the user: {tokens.Name}");
        // }
    }

    private async Task RowSelected(TimelogsResponse.TimelogsDatum timelogsDatum)
    {
        accessToken = await WrikeService.EnsureValidAccessTokenAsync(accessToken, _wrikeId);
        await WrikeService.DeleteTimeLogAsync(accessToken, timelogsDatum.Id);
        timelogs.Data.Remove(timelogsDatum);
    }
}
